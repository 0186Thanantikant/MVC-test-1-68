<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบลงทะเบียนเรียนล่วงหน้า</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container py-10">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">ระบบลงทะเบียนเรียนล่วงหน้า ม.ปลาย</h1>

        <!-- Login View -->
        <div id="login-view" class="card max-w-md mx-auto">
            <h2 class="text-2xl font-semibold text-center mb-6">เข้าสู่ระบบ</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="student-id" class="block text-sm font-medium text-gray-700">รหัสนักเรียน / รหัสแอดมิน</label>
                    <input type="text" id="student-id" name="student-id" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div id="login-error" class="text-red-500 text-sm hidden"></div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    เข้าสู่ระบบ
                </button>
            </form>
        </div>

        <!-- Admin Student List View -->
        <div id="admin-view" class="hidden">
            <div class="card mb-6">
                <h2 class="text-2xl font-semibold mb-4">หน้ารวมนักเรียน (สำหรับแอดมิน)</h2>
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <input type="text" id="search-input" placeholder="ค้นหาตามชื่อ..." class="flex-grow px-3 py-2 border rounded-md">
                    <select id="school-filter" class="px-3 py-2 border rounded-md">
                        <option value="">กรองตามโรงเรียน</option>
                    </select>
                    <select id="sort-by" class="px-3 py-2 border rounded-md">
                        <option value="">เรียงตาม...</option>
                        <option value="name">ชื่อ</option>
                        <option value="age">อายุ</option>
                    </select>
                </div>
                <table class="min-w-full divide-y divide-gray-200 shadow-sm rounded-lg overflow-hidden">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รหัสนักเรียน</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อ-นามสกุล</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">โรงเรียน</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">อายุ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                        </tr>
                    </thead>
                    <tbody id="student-list-body" class="bg-white divide-y divide-gray-200">
                        <!-- Student data rows will be injected here -->
                    </tbody>
                </table>
            </div>
            <div class="flex gap-4">
                <button onclick="navigateTo('grade-entry-view')" class="btn-primary py-2 px-4 rounded-md">กรอกเกรด</button>
                <button onclick="logout()" class="btn-secondary py-2 px-4 rounded-md">ออกจากระบบ</button>
            </div>
        </div>

        <!-- Student Profile View -->
        <div id="student-profile-view" class="hidden">
            <div class="card mb-6">
                <h2 class="text-2xl font-semibold mb-4">ประวัติของนักเรียน</h2>
                <div id="student-details" class="mb-4">
                    <!-- Student details will be injected here -->
                </div>
                <h3 class="text-xl font-semibold mb-2">รายวิชาที่ลงทะเบียนแล้ว</h3>
                <ul id="registered-subjects-list" class="list-disc pl-5">
                    <!-- Registered subjects and grades will be injected here -->
                </ul>
            </div>
            <!-- Action buttons for student or admin -->
            <div id="profile-actions" class="flex gap-4">
                <!-- Buttons will be injected here based on user type -->
            </div>
        </div>
        
        <!-- Registration View -->
        <div id="registration-page" class="hidden">
            <div class="card mb-6">
                <h2 class="text-2xl font-semibold mb-4">หน้าลงทะเบียนเรียน</h2>
                <div id="registration-form" class="space-y-4">
                    <!-- Available subjects will be injected here -->
                </div>
            </div>
            <button onclick="navigateTo('student-profile-view')" class="btn-secondary py-2 px-4 rounded-md">ย้อนกลับ</button>
        </div>

        <!-- Admin Grade Entry View -->
        <div id="grade-entry-view" class="hidden card">
            <h2 class="text-2xl font-semibold mb-4">หน้ากรอกเกรด (สำหรับแอดมิน)</h2>
            <div class="mb-4">
                <label for="subject-select" class="block text-sm font-medium text-gray-700 mb-1">เลือกรายวิชา:</label>
                <select id="subject-select" class="w-full px-3 py-2 border rounded-md">
                    <option value="">-- เลือกรายวิชา --</option>
                </select>
            </div>
            
            <div id="grade-entry-info" class="mb-4">
                <p class="text-md font-semibold text-gray-800" id="selected-subject-name"></p>
                <p class="text-sm text-gray-500" id="registered-count"></p>
            </div>

            <form id="grade-entry-form" class="space-y-4">
                <div id="grade-entry-students">
                    <!-- Student list for grade entry will be injected here -->
                </div>
                <button type="submit" class="btn-primary py-2 px-4 rounded-md">บันทึกเกรด</button>
            </form>
            <div class="mt-4">
                <button onclick="navigateTo('admin-view')" class="btn-secondary py-2 px-4 rounded-md">ย้อนกลับ</button>
            </div>
        </div>

    </div>

    <!-- Custom Modal for Alerts -->
    <div id="modal-backdrop" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="modal-message"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-ok-btn" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        ตกลง
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Model: Database & Business Logic ---
        // Mock Database with Sample Data (JSON)
        const mockDatabase = {
            students: [
                { id: '69000001', prefix: 'นาย', name: 'มานะ', surname: 'รักเรียน', dob: '2008-01-15', school: 'โรงเรียนก้าวหน้า', email: 'mana@example.com', curriculumId: '10101010' },
                { id: '69000002', prefix: 'นางสาว', name: 'มานี', surname: 'รักดี', dob: '2007-03-20', school: 'โรงเรียนก้าวหน้า', email: 'manee@example.com', curriculumId: '10101011' },
                { id: '69000003', prefix: 'นาย', name: 'ชูใจ', surname: 'ใฝ่ฝัน', dob: '2008-05-10', school: 'โรงเรียนอนาคต', email: 'choojai@example.com', curriculumId: '10101010' },
                { id: '69000004', prefix: 'นางสาว', name: 'เพชร', surname: 'สดใส', dob: '2007-08-01', school: 'โรงเรียนอนาคต', email: 'petch@example.com', curriculumId: '10101011' },
                { id: '69000005', prefix: 'นาย', name: 'กล้า', surname: 'หาญ', dob: '2008-09-25', school: 'โรงเรียนวิทยา', email: 'kla@example.com', curriculumId: '10101010' },
                { id: '69000006', prefix: 'นางสาว', name: 'แก้ว', surname: 'ใจดี', dob: '2007-06-12', school: 'โรงเรียนวิทยา', email: 'kaew@example.com', curriculumId: '10101011' },
                { id: '69000007', prefix: 'นาย', name: 'เอก', surname: 'เก่งกาจ', dob: '2008-02-28', school: 'โรงเรียนก้าวหน้า', email: 'aek@example.com', curriculumId: '10101010' },
                { id: '69000008', prefix: 'นางสาว', name: 'รุ่ง', surname: 'อรุณ', dob: '2007-11-17', school: 'โรงเรียนอนาคต', email: 'rung@example.com', curriculumId: '10101011' },
                { id: '69000009', prefix: 'นาย', name: 'ธนา', surname: 'มั่งคั่ง', dob: '2008-04-03', school: 'โรงเรียนวิทยา', email: 'thana@example.com', curriculumId: '10101010' },
                { id: '69000010', prefix: 'นางสาว', name: 'ฟ้า', surname: 'ใส', dob: '2007-09-09', school: 'โรงเรียนก้าวหน้า', email: 'fah@example.com', curriculumId: '10101011' },
            ],
            admin: { id: 'admin123', name: 'แอดมิน' },
            subjects: [
                { id: '05500001', name: 'การเขียนโปรแกรมเบื้องต้น', credits: 3, teacher: 'ผศ.ดร.สมชาย ใจดี', prerequisite: null },
                { id: '05500002', name: 'โครงสร้างข้อมูล', credits: 3, teacher: 'อ.พรเพ็ญ สุขใจ', prerequisite: '05500001' },
                { id: '05500003', name: 'คณิตศาสตร์พื้นฐาน', credits: 3, teacher: 'รศ.ดร.วิชัย รุ่งเรือง', prerequisite: null },
                { id: '05500004', name: 'ฟิสิกส์สำหรับวิทยาการคอมพิวเตอร์', credits: 3, teacher: 'ผศ.ดร.วรวุฒิ คงทน', prerequisite: null },
                { id: '05500005', name: 'ระบบฐานข้อมูล', credits: 3, teacher: 'ผศ.ดร.พงษ์ศักดิ์ บุญมาก', prerequisite: '05500002' },
                { id: '05500006', name: 'เครือข่ายคอมพิวเตอร์', credits: 3, teacher: 'อ.ดวงพร งามดี', prerequisite: '05500001' },
                { id: '90690001', name: 'ภาษาอังกฤษเพื่อการสื่อสาร', credits: 3, teacher: 'รศ.นภา ฤทธิ์เดช', prerequisite: null },
                { id: '90690002', name: 'สังคมกับการพัฒนา', credits: 3, teacher: 'ผศ.สมศรี ศรีสุข', prerequisite: null },
                { id: '90690003', name: 'ศิลปะกับชีวิต', credits: 3, teacher: 'อ.พิชิตชัย ชัยชนะ', prerequisite: null },
                { id: '90690004', name: 'จริยธรรมในสังคมดิจิทัล', credits: 3, teacher: 'อ.อารีรัตน์ รุ่งโรจน์', prerequisite: null },
            ],
            subjectStructures: [
                { curriculumId: '10101010', curriculumName: 'หลักสูตรวิทยาศาสตร์', subjectId: '05500001' },
                { curriculumId: '10101010', curriculumName: 'หลักสูตรวิทยาศาสตร์', subjectId: '05500002' },
                { curriculumId: '10101010', curriculumName: 'หลักสูตรวิทยาศาสตร์', subjectId: '05500004' },
                { curriculumId: '10101010', curriculumName: 'หลักสูตรวิทยาศาสตร์', subjectId: '05500005' },
                { curriculumId: '10101010', curriculumName: 'หลักสูตรวิทยาศาสตร์', subjectId: '05500006' },
                { curriculumId: '10101011', curriculumName: 'หลักสูตรศิลป์คำนวณ', subjectId: '05500003' },
                { curriculumId: '10101011', curriculumName: 'หลักสูตรศิลป์คำนวณ', subjectId: '90690001' },
                { curriculumId: '10101011', curriculumName: 'หลักสูตรศิลป์คำนวณ', subjectId: '90690002' },
                { curriculumId: '10101011', curriculumName: 'หลักสูตรศิลป์คำนวณ', subjectId: '90690003' },
                { curriculumId: '10101011', curriculumName: 'หลักสูตรศิลป์คำนวณ', subjectId: '90690004' },
            ],
            registeredSubjects: [
                { studentId: '69000001', subjectId: '05500001', grade: 'A' },
                { studentId: '69000001', subjectId: '05500003', grade: 'B+' },
                { studentId: '69000003', subjectId: '90690001', grade: null },
            ],
            gradeOptions: ['A', 'B+', 'B', 'C+', 'C', 'D+', 'D', 'F']
        };

        // Model functions
        const model = {
            getStudents: () => mockDatabase.students,
            getAdmin: () => mockDatabase.admin,
            getStudentById: (id) => mockDatabase.students.find(s => s.id === id),
            getSubjects: () => mockDatabase.subjects,
            getSubjectById: (id) => mockDatabase.subjects.find(s => s.id === id),
            getCurriculumById: (id) => mockDatabase.subjectStructures.filter(s => s.curriculumId === id),
            getRegisteredSubjects: (studentId) => mockDatabase.registeredSubjects.filter(rs => rs.studentId === studentId),
            registerSubject: (studentId, subjectId) => {
                const isRegistered = mockDatabase.registeredSubjects.some(rs => rs.studentId === studentId && rs.subjectId === subjectId);
                if (!isRegistered) {
                    mockDatabase.registeredSubjects.push({ studentId, subjectId, grade: null });
                    return true;
                }
                return false;
            },
            updateGrade: (studentId, subjectId, grade) => {
                const regSubject = mockDatabase.registeredSubjects.find(rs => rs.studentId === studentId && rs.subjectId === subjectId);
                if (regSubject) {
                    regSubject.grade = grade;
                    return true;
                }
                return false;
            },
            getGradeOptions: () => mockDatabase.gradeOptions,
            getStudentsForSubject: (subjectId) => {
                const studentIds = new Set(mockDatabase.registeredSubjects.filter(rs => rs.subjectId === subjectId && rs.grade === null).map(rs => rs.studentId));
                return mockDatabase.students.filter(s => studentIds.has(s.id));
            }
        };

        // --- 2. Controller: Application Logic & Event Handling ---
        let currentUser = null;

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const studentId = document.getElementById('student-id').value;
            const errorElement = document.getElementById('login-error');

            if (studentId === model.getAdmin().id) {
                currentUser = model.getAdmin();
                view.renderAdminView();
                navigateTo('admin-view');
            } else {
                const student = model.getStudentById(studentId);
                if (student) {
                    // Business Rule: Student must be at least 15 years old.
                    const birthDate = new Date(student.dob);
                    const ageDiffMs = Date.now() - birthDate.getTime();
                    const ageDate = new Date(ageDiffMs);
                    const age = Math.abs(ageDate.getUTCFullYear() - 1970);
                    
                    if (age >= 15) {
                        currentUser = student;
                        navigateTo('student-profile-view');
                    } else {
                        view.showModal('เข้าสู่ระบบไม่สำเร็จ', 'นักเรียนต้องมีอายุอย่างน้อย 15 ปี');
                        errorElement.textContent = 'นักเรียนต้องมีอายุอย่างน้อย 15 ปี';
                        errorElement.classList.remove('hidden');
                    }
                } else {
                    view.showModal('เข้าสู่ระบบไม่สำเร็จ', 'ไม่พบรหัสนักเรียน');
                    errorElement.textContent = 'ไม่พบรหัสนักเรียน';
                    errorElement.classList.remove('hidden');
                }
            }
        });

        const navigateTo = (viewId, data = null) => {
            document.querySelectorAll('div[id$="-view"], div[id$="-page"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            
            if (viewId === 'student-profile-view') {
                const studentToView = data || currentUser; // Use the provided student data for admin view, or current user for student view
                if (studentToView) {
                    view.renderStudentProfileView(studentToView);
                }
            } else if (viewId === 'admin-view') {
                view.renderAdminView();
            } else if (viewId === 'registration-page') {
                if (currentUser.id === model.getAdmin().id) {
                    view.showModal('ข้อผิดพลาด', 'คุณไม่มีสิทธิ์เข้าถึงหน้านี้');
                    navigateTo('admin-view');
                    return;
                }
                view.renderRegistrationPage(currentUser);
            } else if (viewId === 'grade-entry-view' && currentUser && currentUser.id === model.getAdmin().id) {
                view.renderGradeEntryView();
            }
        };

        const handleRegistration = (subjectId) => {
            const studentId = currentUser.id;
            const subject = model.getSubjectById(subjectId);
            if (subject.prerequisite) {
                const prereqGrade = model.getRegisteredSubjects(studentId).find(s => s.subjectId === subject.prerequisite)?.grade;
                if (!prereqGrade || ['D+', 'D', 'F'].includes(prereqGrade)) {
                    view.showModal('ลงทะเบียนไม่สำเร็จ', 'ต้องมีเกรดผ่านในวิชาบังคับก่อนจึงจะลงทะเบียนได้');
                    return;
                }
            }
            
            if (model.registerSubject(studentId, subjectId)) {
                view.showModal('ลงทะเบียนสำเร็จ', 'วิชาถูกเพิ่มในรายการของคุณแล้ว');
                navigateTo('student-profile-view');
            } else {
                view.showModal('ลงทะเบียนไม่สำเร็จ', 'คุณได้ลงทะเบียนวิชานี้ไปแล้ว');
            }
        };

        const handleGradeEntry = (e) => {
            e.preventDefault();
            const form = e.target;
            const subjectSelect = document.getElementById('subject-select');
            const subjectId = subjectSelect.value;
            const students = model.getStudentsForSubject(subjectId);

            let allGradesEntered = true;

            students.forEach(student => {
                const gradeInput = form.querySelector(`select[name="grade-${student.id}"]`);
                if (gradeInput) {
                    const grade = gradeInput.value;
                    if (grade) {
                        model.updateGrade(student.id, subjectId, grade);
                    } else {
                        allGradesEntered = false;
                    }
                }
            });

            if (allGradesEntered && students.length > 0) {
                view.showModal('บันทึกเกรดสำเร็จ', 'เกรดทั้งหมดได้ถูกบันทึกเรียบร้อยแล้ว');
                // Re-render the grade entry view for the same subject to reflect changes
                view.renderGradeEntryView(subjectId);
            } else {
                view.showModal('บันทึกเกรดไม่สำเร็จ', 'กรุณากรอกเกรดให้ครบถ้วน');
            }
        };
        
        const logout = () => {
            currentUser = null;
            navigateTo('login-view');
        };

        // --- 3. View: Rendering UI & Display Logic ---
        const view = {
            showModal: (title, message) => {
                const modal = document.getElementById('modal-backdrop');
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').textContent = message;
                modal.classList.remove('hidden');

                document.getElementById('modal-ok-btn').onclick = () => {
                    modal.classList.add('hidden');
                };
            },
            renderAdminView: () => {
                const students = model.getStudents();
                const studentListBody = document.getElementById('student-list-body');
                const schoolFilter = document.getElementById('school-filter');
                const searchInput = document.getElementById('search-input');
                const sortBy = document.getElementById('sort-by');
                
                const allSchools = [...new Set(students.map(s => s.school))];
                schoolFilter.innerHTML = '<option value="">กรองตามโรงเรียน</option>' + allSchools.map(s => `<option value="${s}">${s}</option>`).join('');

                const renderStudents = () => {
                    let filteredStudents = students;
                    const searchTerm = searchInput.value.toLowerCase();
                    const filterSchool = schoolFilter.value;
                    const sortOption = sortBy.value;

                    // Filter
                    if (searchTerm) {
                        filteredStudents = filteredStudents.filter(s => s.name.toLowerCase().includes(searchTerm) || s.surname.toLowerCase().includes(searchTerm));
                    }
                    if (filterSchool) {
                        filteredStudents = filteredStudents.filter(s => s.school === filterSchool);
                    }

                    // Sort
                    if (sortOption === 'name') {
                        filteredStudents.sort((a, b) => (a.name + a.surname).localeCompare(b.name + b.surname));
                    } else if (sortOption === 'age') {
                        filteredStudents.sort((a, b) => {
                            const ageA = new Date().getFullYear() - new Date(a.dob).getFullYear();
                            const ageB = new Date().getFullYear() - new Date(b.dob).getFullYear();
                            return ageA - ageB;
                        });
                    }

                    studentListBody.innerHTML = filteredStudents.map(student => `
                        <tr class="hover:bg-gray-50 cursor-pointer" onclick="view.renderStudentDetailForAdmin('${student.id}')">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.prefix} ${student.name} ${student.surname}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.school}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date().getFullYear() - new Date(student.dob).getFullYear()}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <a href="#" class="text-indigo-600 hover:text-indigo-900">ดูโปรไฟล์</a>
                            </td>
                        </tr>
                    `).join('');
                };

                searchInput.addEventListener('input', renderStudents);
                schoolFilter.addEventListener('change', renderStudents);
                sortBy.addEventListener('change', renderStudents);
                
                renderStudents();
            },
            renderStudentDetailForAdmin: (studentId) => {
                const studentToView = model.getStudentById(studentId);
                navigateTo('student-profile-view', studentToView);
            },
            renderStudentProfileView: (student) => {
                const studentDetails = document.getElementById('student-details');
                const registeredSubjectsList = document.getElementById('registered-subjects-list');
                const profileActions = document.getElementById('profile-actions');
                const registeredSubjects = model.getRegisteredSubjects(student.id);
                
                // Determine user type based on the global currentUser
                const isAdmin = currentUser && currentUser.id === model.getAdmin().id;
                
                const curriculumData = model.getCurriculumById(student.curriculumId);
                const curriculumName = curriculumData.length > 0 ? curriculumData[0].curriculumName : 'ไม่พบข้อมูล';

                studentDetails.innerHTML = `
                    <p><strong>รหัสนักเรียน:</strong> ${student.id}</p>
                    <p><strong>ชื่อ-นามสกุล:</strong> ${student.prefix} ${student.name} ${student.surname}</p>
                    <p><strong>วันเกิด:</strong> ${student.dob}</p>
                    <p><strong>โรงเรียน:</strong> ${student.school}</p>
                    <p><strong>อีเมล:</strong> ${student.email}</p>
                    <p><strong>หลักสูตรที่ลงทะเบียน:</strong> ${curriculumName}</p>
                `;

                registeredSubjectsList.innerHTML = registeredSubjects.map(regSub => {
                    const subject = model.getSubjectById(regSub.subjectId);
                    
                    // The "Enter Grade" button is removed from the profile page to prevent confusion.
                    // All grade entry actions should be handled via the dedicated "Grade Entry" view.
                    return `
                        <li>
                            <span class="font-medium">${subject.name} (${subject.id})</span>: 
                            <span class="font-bold text-gray-700">${regSub.grade ? `เกรด ${regSub.grade}` : 'รอเกรด'}</span>
                        </li>
                    `;
                }).join('') || '<li class="text-gray-500">ยังไม่มีรายวิชาที่ลงทะเบียน</li>';

                if (!isAdmin) {
                    profileActions.innerHTML = `
                        <button onclick="navigateTo('registration-page')" class="btn-primary py-2 px-4 rounded-md">ลงทะเบียนเรียน</button>
                        <button onclick="logout()" class="btn-secondary py-2 px-4 rounded-md">ออกจากระบบ</button>
                    `;
                } else {
                    profileActions.innerHTML = `
                        <button onclick="navigateTo('admin-view')" class="btn-secondary py-2 px-4 rounded-md">ย้อนกลับ</button>
                        <button onclick="logout()" class="btn-secondary py-2 px-4 rounded-md">ออกจากระบบ</button>
                    `;
                }
            },
            renderRegistrationPage: (student) => {
                const registrationForm = document.getElementById('registration-form');
                const curriculumSubjects = model.getCurriculumById(student.curriculumId);
                const registeredSubjects = model.getRegisteredSubjects(student.id).map(s => s.subjectId);
                
                const availableSubjects = curriculumSubjects
                    .map(ss => model.getSubjectById(ss.subjectId))
                    .filter(sub => !registeredSubjects.includes(sub.id));

                if (availableSubjects.length === 0) {
                    registrationForm.innerHTML = '<p class="text-gray-500">ไม่มีรายวิชาให้ลงทะเบียนเพิ่มเติมในขณะนี้</p>';
                    return;
                }

                registrationForm.innerHTML = availableSubjects.map(subject => `
                    <div class="p-4 border border-gray-200 rounded-md">
                        <p class="text-lg font-medium">${subject.name} (${subject.id})</p>
                        <p class="text-sm text-gray-500">หน่วยกิต: ${subject.credits}, อาจารย์: ${subject.teacher}</p>
                        ${subject.prerequisite ? `<p class="text-sm text-red-500 font-semibold">วิชาบังคับก่อน: ${model.getSubjectById(subject.prerequisite).name}</p>` : ''}
                        <button onclick="handleRegistration('${subject.id}')" class="mt-2 btn-primary py-1 px-3 rounded-md text-sm">ลงทะเบียน</button>
                    </div>
                `).join('');
            },
            renderGradeEntryView: (selectedSubjectId = '') => {
                const subjectSelect = document.getElementById('subject-select');
                const studentsListContainer = document.getElementById('grade-entry-students');
                const selectedSubjectName = document.getElementById('selected-subject-name');
                const registeredCount = document.getElementById('registered-count');
                const gradeEntryForm = document.getElementById('grade-entry-form');

                // Clear previous state and add all subjects to the dropdown
                subjectSelect.innerHTML = '<option value="">-- เลือกรายวิชา --</option>';
                const allSubjects = model.getSubjects();
                allSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    subjectSelect.appendChild(option);
                });
                
                // Select the passed subject if available
                if (selectedSubjectId) {
                    subjectSelect.value = selectedSubjectId;
                }

                // Event listener for subject selection
                subjectSelect.onchange = () => {
                    const subjectId = subjectSelect.value;
                    const students = subjectId ? model.getStudentsForSubject(subjectId) : [];
                    const subject = subjectId ? model.getSubjectById(subjectId) : null;
                    
                    selectedSubjectName.textContent = subject ? `รายชื่อนักเรียนสำหรับวิชา: ${subject.name}` : '';
                    registeredCount.textContent = subject ? `นักเรียนที่ยังไม่ได้รับเกรด: ${students.length} คน` : '';

                    studentsListContainer.innerHTML = students.map(student => `
                        <div class="flex items-center space-x-4 p-2 border-b">
                            <p class="flex-grow">${student.prefix} ${student.name} ${student.surname} (${student.id})</p>
                            <select name="grade-${student.id}" class="px-2 py-1 border rounded-md">
                                <option value="">เลือกเกรด</option>
                                ${model.getGradeOptions().map(grade => `<option value="${grade}">${grade}</option>`).join('')}
                            </select>
                        </div>
                    `).join('') || '<p class="text-gray-500">ไม่มีนักเรียนที่รอเกรดในวิชานี้</p>';
                    
                    // Show or hide submit button based on students
                    gradeEntryForm.querySelector('button[type="submit"]').classList.toggle('hidden', students.length === 0);
                };

                // Trigger change event to load initial data if a subject is pre-selected
                if (selectedSubjectId) {
                    subjectSelect.onchange();
                }

                gradeEntryForm.onsubmit = handleGradeEntry;
            },
        };

        // Initialize the app on page load
        document.addEventListener('DOMContentLoaded', () => {
            navigateTo('login-view');
        });
    </script>
</body>
</html>